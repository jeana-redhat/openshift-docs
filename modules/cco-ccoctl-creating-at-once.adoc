// Module included in the following assemblies:
//
// * authentication/managing_cloud_provider_credentials/cco-mode-sts.adoc
// * installing/installing_alibaba/manually-creating-alibaba-ram.adoc

ifeval::["{context}" == "cco-mode-sts"]
:aws:
endif::[]
ifeval::["{context}" == "manually-creating-alibaba-ram"]
:alibaba:
endif::[]

:_content-type: PROCEDURE
ifdef::aws[]
[id="cco-ccoctl-creating-at-once_{context}"]
= Creating AWS resources with a single command

If you do not need to review the JSON files that the `ccoctl` tool creates before modifying AWS resources, and if the process the `ccoctl` tool uses to create AWS resources automatically meets the requirements of your organization, you can use the `ccoctl aws create-all` command to automate the creation of AWS resources.

Otherwise, you can create the AWS resources individually.

//to-do if possible: xref to modules/cco-ccoctl-creating-individually.adoc for `create the AWS resources individually`
endif::aws[]
ifdef::alibaba[]
[id="cco-ccoctl-creating-at-once_{context}"]
= Creating Alibaba Cloud RAM users with ccoctl

You can use the `ccoctl alibabacloud create-ram-users` command to automate the creation of Alibaba Cloud RAM users and policies for each in-cluster component.
endif::alibaba[]

[NOTE]
====
By default, `ccoctl` creates objects in the directory in which the commands are run. To specify a directory, use the `--output-dir` flag. This procedure uses `<path_to_ccoctl_output_dir>` to refer to this location.
====

.Prerequisites

* Extract and prepare the `ccoctl` binary.
ifdef::alibaba[]
* Obtain the AccessKey (AK) of the RAM user you wish to use.
* Use the AK of the chosen RAM user to configure the {alibaba} SDK client's credential provider chain for link:https://github.com/aliyun/alibaba-cloud-sdk-go/blob/master/docs/2-Client-EN.md#1-environment-credentials[Environment Credentials] mode or through link:https://github.com/aliyun/alibaba-cloud-sdk-go/blob/master/docs/2-Client-EN.md#2-credentials-file[Credentials File] mode.
//Note: those Alibaba Cloud docs links are officially intended for user consumption (https://github.com/openshift/cloud-credential-operator/pull/412/files#r764509590). We would prefer not to link to GitHub like this, but an alternative has not yet presented itself.
endif::alibaba[]

.Procedure

. Extract the list of `CredentialsRequest` objects from the {product-title} release image:
+
[source,terminal,subs="+quotes"]
ifdef::aws[]
----
$ oc adm release extract --credentials-requests --cloud=aws --to=<path_to_directory_with_list_of_credentials_requests>/credrequests quay.io/<path_to>/ocp-release:<version>
----
endif::aws[]
ifdef::alibaba[]
----
$ oc adm release extract --credentials-requests --cloud=alibabacloud --to=<path_to_directory_with_list_of_credentials_requests>/credrequests quay.io/<path_to>/ocp-release:<version>
----
endif::alibaba[]

. Use the `ccoctl` tool to process all `CredentialsRequest` objects in the `credrequests` directory:
+
[source,terminal,subs="+quotes"]
ifdef::aws[]
----
$ ccoctl aws create-all --name=<name> --region=<aws_region> --credentials-requests-dir=<path_to_directory_with_list_of_credentials_requests>/credrequests
----
+
where:
+
** `<name>` is the name used to tag any cloud resources that are created for tracking.
** `<aws-region>` is the AWS region in which cloud resources will be created.
** `<path_to_directory_with_list_of_credentials_requests>/credrequests` is the directory containing the files for the component `CredentialsRequest` objects.
endif::aws[]
ifdef::alibaba[]
----
$ ccoctl alibabacloud create-ram-users --name <name> --region=<alibaba-region> --credentials-requests-dir=<path_to_directory_with_list_of_credentials_requests>/credrequests
----
+
where:
+
** `<name>` is the name used to tag any cloud resources that are created for tracking.
** `<alibaba-region>` is the Alibaba Cloud region in which cloud resources will be created.
** `<path_to_directory_with_list_of_credentials_requests>/credrequests` is the directory containing the files for the component `CredentialsRequest` objects.
+
[NOTE]
====
A RAM user can have up to two AccessKeys at the same time. If you run `ccoctl alibabacloud create-ram-users` more than twice, the previous generated manifests secret becomes stale and you must reapply the newly generated secrets.
====
endif::alibaba[]

.Verification

* To verify that the {product-title} secrets are created, list the files in the `<path_to_ccoctl_output_dir>/manifests` directory:
+
[source,terminal,subs="+quotes"]
----
$ ls <path_to_ccoctl_output_dir>/manifests
----
+
.Example output:
+
[source,terminal,subs="+quotes"]
ifdef::aws[]
----
cluster-authentication-02-config.yaml
openshift-cloud-credential-operator-cloud-credential-operator-iam-ro-creds-credentials.yaml
openshift-cluster-csi-drivers-ebs-cloud-credentials-credentials.yaml
openshift-image-registry-installer-cloud-credentials-credentials.yaml
openshift-ingress-operator-cloud-credentials-credentials.yaml
openshift-machine-api-aws-cloud-credentials-credentials.yaml
----

You can verify that the IAM roles are created by querying AWS. For more information, refer to AWS documentation on listing IAM roles.
endif::aws[]
ifdef::alibaba[]
----
openshift-cluster-csi-drivers-alibaba-disk-credentials-credentials.yaml
openshift-image-registry-installer-cloud-credentials-credentials.yaml
openshift-ingress-operator-cloud-credentials-credentials.yaml
openshift-machine-api-alibabacloud-credentials-credentials.yaml
----

You can verify that the RAM users and policies are created by querying Alibaba Cloud. For more information, refer to Alibaba Cloud documentation on listing RAM users and policies.
endif::alibaba[]
