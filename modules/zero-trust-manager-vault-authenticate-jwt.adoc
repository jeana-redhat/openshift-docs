// Module included in the following assemblies:
//
// * security/zero_trust_workload_identity_manageer/zero-trust-manager-oidc-federation.adoc

:_mod-docs-content-type: PROCEDURE
[id="zero-trust-manager-vault-authenticate-jwt_{context}"]
= Configuring JSON Web Token authentication with SPIRE

You need to set up JSON Web Token (JWT) authentication so your applications can securely log in to Vault by using SPIFFE identities.

.Prerequisites

* Make sure that Vault is initialized and unsealed.

* Ensure that a test secret is stored in the key-value secrets engine.

.Procedure

. On your local machine, retrieve the SPIRE Certificate Authority (CA) bundle and save it to a file:
+
[source,terminal]
----
$ oc get cm -n zero-trust-workload-identity-manager spire-bundle -o jsonpath='{ .data.bundle\.crt }' > oidc_provider_ca.pem
----

. Back in the Vault pod shell, create a temporary file and paste the contents of `oidc_provider_ca.pem` into it:
+
[source,terminal]
----
$ cat << EOF > /tmp/oidc_provider_ca.pem
-----BEGIN CERTIFICATE-----
<Paste-Your-Certificate-Content-Here>
-----END CERTIFICATE-----
EOF
----

. Set up the necessary environment variables for the JWT configuration:
+
[source,terminal]
----
$ export APP_DOMAIN=<Your-App-Domain>
$ export JWT_ISSUER_ENDPOINT="oidc-discovery.$APP_DOMAIN"
$ export OIDC_URL="https://$JWT_ISSUER_ENDPOINT"
$ export OIDC_CA_PEM="$(cat /tmp/oidc_provider_ca.pem)"
----

. Enable the JWT authentication method and configure it with your OIDC provider details:
+
[source,terminal]
----
$ export ROLE="${NAME}-role"
$ vault auth enable jwt
$ vault write auth/jwt/config \
  oidc_discovery_url=$OIDC_URL \
  oidc_discovery_ca_pem="$OIDC_CA_PEM" \
  default_role=$ROLE
----

. Create a policy named `ztwim-policy` that grants read access to the secret you created earlier:
+
[source,terminal]
----
$ export POLICY="${NAME}-policy"
$ vault policy write $POLICY -<<EOF
path "secret/$NAME" {
    capabilities = ["read"]
}
EOF
----

. Create a JWT role that binds the policy to workload with a specific SPIFFE ID:
+
[source,terminal]
----
$ export APP_NAME=client
$ export APP_NAMESPACE=demo
$ export AUDIENCE=$APP_NAME
$ vault write auth/jwt/role/$ROLE -<<EOF
{
  "role_type": "jwt",
  "user_claim": "sub",
  "bound_audiences": "$AUDIENCE",
  "bound_claims_type": "glob",
  "bound_claims": {
    "sub": "spiffe://$APP_DOMAIN/ns/$APP_NAMESPACE/sa/$APP_NAME"
  },
  "token_ttl": "24h",
  "token_policies": "$POLICY"
}
EOF
----