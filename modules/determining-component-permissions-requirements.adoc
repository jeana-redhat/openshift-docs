// Module included in the following assemblies:
//
// * installing/installing_gcp/installing-gcp-customizations.adoc

:_mod-docs-content-type: PROCEDURE
[id="determining-component-permissions-requirements_{context}"]
= Determining component permissions requirements

In addition to the permissions that the installation program requires, the service account that you use during installation must include permissions for the {product-title} components in your cluster configuration.

If the security policies of your organization require more restrictive access than the installation process uses by default, you can add any missing access requirements for components to the service account.
You can determine the required permissions by inspecting the contents of the `CredentialsRequest` manifests for each component.

.Prerequisites

* You have created a cloud provider account for the installation program that has the required permissions to create the {product-title} cluster.
* You have downloaded the installation program file.
* You have installed the {oc-first}.
* You have access to an {product-title} account with cluster administrator access

.Procedure

. Change to the directory that contains the installation program.

. Set a `$RELEASE_IMAGE` variable with the release image from your installation file by running the following command:
+
[source,terminal]
----
$ RELEASE_IMAGE=$(./openshift-install version | awk '/release image/ {print $3}')
----

. Extract the list of `CredentialsRequest` objects from the {product-title} release image by running the following command:
+
[source,terminal]
----
$ oc adm release extract \
  --from=$RELEASE_IMAGE \
  --credentials-requests \
  --included \// <1>
  --install-config=<path_to_directory_with_installation_configuration>/install-config.yaml \// <2>
  --to=<path_to_directory_for_credentials_requests> <3>
----
<1> The `--included` parameter includes only the manifests that your specific cluster configuration requires.
<2> Specify the location of the `install-config.yaml` file.
<3> Specify the path to the directory where you want to store the `CredentialsRequest` objects. If the specified directory does not exist, this command creates it.
+
[NOTE]
====
This command might take a few moments to run.
====

. Verify the contents of the directory where you want to store the `CredentialsRequest` objects by running the following command:
+
[source,terminal]
----
$ ls <path_to_directory_for_credentials_requests>
----
+
.Example output
+
[source,text]
----
0000_30_cluster-api_00_credentials-request.yaml
0000_30_machine-api-operator_00_credentials-request.yaml
0000_50_cloud-credential-operator_05-iam-ro-credentialsrequest.yaml
0000_50_cluster-image-registry-operator_01-registry-credentials-request.yaml
0000_50_cluster-ingress-operator_00-ingress-credentials-request.yaml
0000_50_cluster-network-operator_02-cncc-credentials.yaml
0000_50_cluster-storage-operator_03_credentials_request_aws.yaml

//todo: make this output correct per-platform
----
+
Each YAML file is a `CredentialsRequest` manifest for an {product-title} component in your cluster configuration. Each manifest contains the permissions requirements for its component.

. To view the permissions requirements for a specific component, run the following command:
+
[source,terminal]
----
$ cat <component_credentials_request>
----
+
where `<component_credentials_request>` is a file in `<path_to_directory_for_credentials_requests>`.
+
.Example output for the Machine API `CredentialsRequest` manifest
+
[source,yaml]
----
apiVersion: cloudcredential.openshift.io/v1
kind: CredentialsRequest
metadata:
  annotations:
    capability.openshift.io/name: MachineAPI+CloudCredential
tag::provAlibaba[]
  name: openshift-machine-api-alibabacloud
  namespace: openshift-cloud-credential-operator
spec:
  providerSpec:
    apiVersion: cloudcredential.openshift.io/v1
    kind: AlibabaCloudProviderSpec
    statementEntries:
    - action:
      - ecs:DeleteInstances
      - ecs:DescribeImages
      - ecs:DescribeInstances
      - ecs:DescribeSecurityGroups
      - ecs:RunInstances
      - ecs:StopInstances
      - ecs:TagResources
      effect: Allow
      resource: '*'
    - action:
      - vpc:DescribeVpcs
      - vpc:DescribeVSwitches
      - ram:PassRole
      effect: Allow
      resource: '*'
  secretRef:
    name: alibabacloud-credentials
    namespace: openshift-machine-api
end::provAlibaba[]
tag::provAWS[]
    exclude.release.openshift.io/internal-openshift-hosted: "true"
    include.release.openshift.io/self-managed-high-availability: "true"
  labels:
    controller-tools.k8s.io: "1.0"
  name: openshift-machine-api-aws
  namespace: openshift-cloud-credential-operator
spec:
  providerSpec:
    apiVersion: cloudcredential.openshift.io/v1
    kind: AWSProviderSpec
    statementEntries:
    - action:
      - ec2:CreateTags
      - ec2:DescribeAvailabilityZones
      - ec2:DescribeDhcpOptions
      - ec2:DescribeImages
      - ec2:DescribeInstances
      - ec2:DescribeInstanceTypes
      - ec2:DescribeInternetGateways
      - ec2:DescribeSecurityGroups
      - ec2:DescribeRegions
      - ec2:DescribeSubnets
      - ec2:DescribeVpcs
      - ec2:RunInstances
      - ec2:TerminateInstances
      - elasticloadbalancing:DescribeLoadBalancers
      - elasticloadbalancing:DescribeTargetGroups
      - elasticloadbalancing:DescribeTargetHealth
      - elasticloadbalancing:RegisterInstancesWithLoadBalancer
      - elasticloadbalancing:RegisterTargets
      - elasticloadbalancing:DeregisterTargets
      - iam:PassRole
      - iam:CreateServiceLinkedRole
      effect: Allow
      resource: '*'
    - action:
      - kms:Decrypt
      - kms:Encrypt
      - kms:GenerateDataKey
      - kms:GenerateDataKeyWithoutPlainText
      - kms:DescribeKey
      effect: Allow
      resource: '*'
    - action:
      - kms:RevokeGrant
      - kms:CreateGrant
      - kms:ListGrants
      effect: Allow
      policyCondition:
        Bool:
          kms:GrantIsForAWSResource: true
      resource: '*'
  secretRef:
    name: aws-cloud-credentials
    namespace: openshift-machine-api
  serviceAccountNames:
  - machine-api-controllers
end::provAWS[]
tag::provAzure[]
    exclude.release.openshift.io/internal-openshift-hosted: "true"
    include.release.openshift.io/self-managed-high-availability: "true"
  labels:
    controller-tools.k8s.io: "1.0"
  name: openshift-machine-api-azure
  namespace: openshift-cloud-credential-operator
spec:
  providerSpec:
    apiVersion: cloudcredential.openshift.io/v1
    kind: AzureProviderSpec
    permissions:
    - Microsoft.Compute/availabilitySets/delete
    - Microsoft.Compute/availabilitySets/read
    - Microsoft.Compute/availabilitySets/write
    - Microsoft.Compute/diskEncryptionSets/read
    - Microsoft.Compute/disks/delete
    - Microsoft.Compute/galleries/images/versions/read
    - Microsoft.Compute/skus/read
    - Microsoft.Compute/virtualMachines/delete
    - Microsoft.Compute/virtualMachines/extensions/delete
    - Microsoft.Compute/virtualMachines/extensions/read
    - Microsoft.Compute/virtualMachines/extensions/write
    - Microsoft.Compute/virtualMachines/read
    - Microsoft.Compute/virtualMachines/write
    - Microsoft.ManagedIdentity/userAssignedIdentities/assign/action
    - Microsoft.Network/applicationSecurityGroups/read
    - Microsoft.Network/loadBalancers/backendAddressPools/join/action
    - Microsoft.Network/loadBalancers/read
    - Microsoft.Network/loadBalancers/write
    - Microsoft.Network/networkInterfaces/delete
    - Microsoft.Network/networkInterfaces/join/action
    - Microsoft.Network/networkInterfaces/loadBalancers/read
    - Microsoft.Network/networkInterfaces/read
    - Microsoft.Network/networkInterfaces/write
    - Microsoft.Network/networkSecurityGroups/read
    - Microsoft.Network/networkSecurityGroups/write
    - Microsoft.Network/publicIPAddresses/delete
    - Microsoft.Network/publicIPAddresses/join/action
    - Microsoft.Network/publicIPAddresses/read
    - Microsoft.Network/publicIPAddresses/write
    - Microsoft.Network/routeTables/read
    - Microsoft.Network/virtualNetworks/delete
    - Microsoft.Network/virtualNetworks/read
    - Microsoft.Network/virtualNetworks/subnets/join/action
    - Microsoft.Network/virtualNetworks/subnets/read
    - Microsoft.Resources/subscriptions/resourceGroups/read
  secretRef:
    name: azure-cloud-credentials
    namespace: openshift-machine-api
  serviceAccountNames:
  - machine-api-controllers
end::provAzure[]
tag::provGCP[]
    exclude.release.openshift.io/internal-openshift-hosted: "true"
    include.release.openshift.io/self-managed-high-availability: "true"
  labels:
    controller-tools.k8s.io: "1.0"
  name: openshift-machine-api-gcp
  namespace: openshift-cloud-credential-operator
spec:
  providerSpec:
    apiVersion: cloudcredential.openshift.io/v1
    kind: GCPProviderSpec
    predefinedRoles:
    - roles/compute.admin
    - roles/iam.serviceAccountUser
  secretRef:
    name: gcp-cloud-credentials
    namespace: openshift-machine-api
  serviceAccountNames:
  - machine-api-controllers
end::provGCP[]
tag::provIBMcloud[]
    include.release.openshift.io/self-managed-high-availability: "true"
  labels:
    controller-tools.k8s.io: "1.0"
  name: openshift-machine-api-ibmcloud
  namespace: openshift-cloud-credential-operator
spec:
  providerSpec:
    apiVersion: cloudcredential.openshift.io/v1
    kind: IBMCloudProviderSpec
    policies:
    - attributes:
      - name: serviceName
        value: is
      roles:
      - crn:v1:bluemix:public:iam::::role:Operator
      - crn:v1:bluemix:public:iam::::role:Editor
      - crn:v1:bluemix:public:iam::::role:Viewer
    - attributes:
      - name: resourceType
        value: resource-group
      roles:
      - crn:v1:bluemix:public:iam::::role:Viewer
  secretRef:
    name: ibmcloud-credentials
    namespace: openshift-machine-api
end::provIBMcloud[]
tag::provIBMpowerVS[]
    include.release.openshift.io/self-managed-high-availability: "true"
  labels:
    controller-tools.k8s.io: "1.0"
  name: openshift-machine-api-powervs
  namespace: openshift-cloud-credential-operator
spec:
  providerSpec:
    apiVersion: cloudcredential.openshift.io/v1
    kind: IBMCloudPowerVSProviderSpec
    policies:
      - roles:
          - "crn:v1:bluemix:public:iam::::role:Viewer"
          - "crn:v1:bluemix:public:iam::::serviceRole:Reader"
          - "crn:v1:bluemix:public:iam::::serviceRole:Manager"
        attributes:
          - name: "serviceName"
            value: "power-iaas"
      - roles:
          - "crn:v1:bluemix:public:iam::::role:Viewer"
        attributes:
          - name: "resourceType"
            value: "resource-group"
      - roles:
          - "crn:v1:bluemix:public:iam::::role:Editor"
          - "crn:v1:bluemix:public:iam::::role:Operator"
          - "crn:v1:bluemix:public:iam::::role:Viewer"
        attributes:
          - name: serviceName
            value: is
  secretRef:
    namespace: openshift-machine-api
    name: powervs-credentials
end::provIBMpowerVS[]
tag::provOpenStack[]
    exclude.release.openshift.io/internal-openshift-hosted: "true"
    include.release.openshift.io/self-managed-high-availability: "true"
  labels:
    controller-tools.k8s.io: "1.0"
  name: openshift-machine-api-openstack
  namespace: openshift-cloud-credential-operator
spec:
  secretRef:
    name: openstack-cloud-credentials
    namespace: openshift-machine-api
  providerSpec:
    apiVersion: cloudcredential.openshift.io/v1
    kind: OpenStackProviderSpec
end::provOpenStack[]
tag::provovirt[]
    include.release.openshift.io/self-managed-high-availability: "true"
  labels:
    controller-tools.k8s.io: "1.0"
  name: openshift-machine-api-ovirt
  namespace: openshift-cloud-credential-operator
spec:
  secretRef:
    name: ovirt-credentials
    namespace: openshift-machine-api
  providerSpec:
    apiVersion: cloudcredential.openshift.io/v1
    kind: OvirtProviderSpec
end::provovirt[]
tag::provNutanix[]
    include.release.openshift.io/self-managed-high-availability: "true"
  labels:
    controller-tools.k8s.io: "1.0"
  name: openshift-machine-api-nutanix
  namespace: openshift-cloud-credential-operator
spec:
  providerSpec:
    apiVersion: cloudcredential.openshift.io/v1
    kind: NutanixProviderSpec
  secretRef:
    name: nutanix-credentials
    namespace: openshift-machine-api
end::provNutanix[]
tag::provVMW[]
    include.release.openshift.io/self-managed-high-availability: "true"
  labels:
    controller-tools.k8s.io: "1.0"
  name: openshift-machine-api-vsphere
  namespace: openshift-cloud-credential-operator
spec:
  secretRef:
    name: vsphere-cloud-credentials
    namespace: openshift-machine-api
  providerSpec:
    apiVersion: cloudcredential.openshift.io/v1
    kind: VSphereProviderSpec
end::provVMW[]
----
+
The `providerSpec` stanza contains the permissions requirements. The format of this data varies by component and cloud provider.



////
//pre-4.14
//
. Extract the list of `CredentialsRequest` objects from the {product-title} release image by running the following command:
+
--
[source,terminal]
----
$ oc adm release extract \
  --from=$RELEASE_IMAGE \
  --credentials-requests \
  --cloud=<cloud_provider_name> \// <1>
  --to=<path_to_directory_for_credentials_requests> <2>
----
<1> Specify the value that corresponds to your cloud provider. The following values are valid:
* alibabacloud: Alibaba Cloud
* aws: {aws-full}
* azure: {azure-full}
* gcp: {gcp-full}
* ibmcloud: {ibm-cloud-title}
* nutanix: Nutanix
* openstack: {rh-openstack-first}
* ovirt: {VirtProductName}
* powervs: {ibm-power-server-title}
* vsphere: {vmw-full}
<2> Specify the path to the directory where you want to store the `CredentialsRequest` objects. If the specified directory does not exist, this command creates it.
--
+
[NOTE]
====
This command might take a few moments to run.
====
//
//Note: pre-4.14, the lack of the --included flag means there will be unnecessary manifests for any optional component (capability) the user will not use.
////
